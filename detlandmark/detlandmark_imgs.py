import face_alignment
from skimage import io
import os
import sys
import glob
import cv2
import pickle
import tqdm


from PIL import ImageFile
ImageFile.LOAD_TRUNCATED_IMAGES = True

# list dir
# path_ = "/content/drive/MyDrive/Liveness/Celeb_lab_phase_1/CelebA_Spoof/Data/train"
# dirs_ = os.listdir(path_)
# print(len(dirs_))
# print(dirs_[:50])
# print(dirs_[50:100])
# print(dirs_[100:150])
# print(dirs_[150:200])
# print(dirs_[200:250])
# print(dirs_[250:300])
# print(dirs_[300:])


dirs_1 = ['9027', '9000', '9019', '9029', '9006', '9997', '90', '999', '9003', '902', '9999', '9030', '9993', '900', '9028', '9017', '9024', '9023', '9022', '9015', '9986', '9012', '9016', '9011', '9995', '9984', '9996', '9001', '9007', '9989', '9990', '9026', '9020', '9004', '9013', '9021', '901', '903', '9', '9998', '9991', '9009', '9982', '9002', '9987', '8946', '8830', '8877', '8813', '899']
# dirs_1 = ['8780', '8854', '889', '8817', '8807', '8815', '8973', '881', '8938', '876', '8900', '8988', '8710', '897', '8827', '8723', '8792', '8935', '8825', '8998', '8742', '8898', '8866', '8770', '8929', '8748', '8925', '8738', '888', '8769', '8993', '8711', '8899', '8876', '8816', '8930', '8799', '8766', '8909', '8744', '8950', '8791', '8749', '8833', '8826', '8884', '8964', '8810', '8933', '8823']
# dirs_1 = ['8783', '8802', '8916', '8850', '8753', '8999', '884', '8878', '8955', '8904', '8974', '8718', '8848', '8785', '8928', '8944', '8892', '8926', '8699', '8882', '874', '8860', '8741', '8818', '8863', '8887', '8756', '8967', '8888', '8906', '8732', '878', '8942', '8779', '8856', '8910', '8897', '892', '886', '8800', '8706', '8838', '8972', '8751', '8981', '8979', '8782', '8932', '8919', '898']
# dirs_1 = ['873', '8820', '8905', '8958', '8939', '8712', '8767', '8795', '8952', '8889', '8747', '8893', '8746', '8724', '8768', '8971', '8983', '8704', '8977', '8765', '896', '8966', '8903', '8990', '8915', '8872', '8885', '8784', '8812', '8956', '8997', '8953', '885', '8874', '8721', '8840', '8959', '88', '8920', '8957', '8968', '8991', '8796', '8994', '8755', '872', '8980', '8836', '8702', '8763']
# dirs_1 = ['8797', '8941', '8719', '8798', '8737', '8743', '883', '8851', '879', '8839', '8914', '8989', '8891', '8722', '8733', '8788', '8844', '8703', '8720', '8975', '8829', '8934', '8949', '8727', '8809', '8847', '8867', '89', '8837', '8754', '8750', '8858', '8937', '8849', '8954', '8996', '8921', '8868', '8708', '87', '8927', '8864', '8759', '8700', '882', '8962', '8995', '8729', '8790', '8794']
# dirs_1 = ['8761', '8896', '8907', '8843', '8762', '8911', '8705', '8832', '8922', '8976', '8960', '8735', '8764', '8883', '8776', '8923', '8801', '890', '891', '8778', '8982', '8886', '8842', '8846', '8943', '8730', '8725', '8701', '8824', '8739', '871', '8716', '8758', '8808', '895', '8987', '8859', '8805', '8773', '8707', '8947', '8855', '8845', '8819', '8879', '8804', '8831', '8740', '8865', '8940']
# dirs_1 = ['8852', '8908', '894', '8894', '8781', '8857', '8834', '8835', '8875', '8881', '8803', '8969', '8772', '8862', '8970', '8811', '8992', '8697', '869', '86', '8', '9969', '996', '997', '9970', '9971', '9972', '9973', '9974', '9975', '9978', '9979', '998', '9981', '99']

# # imgdirs = glob.glob(os.path.join(os.path.abspath(sys.argv[1]), '*/*/*.jpg'))

imgdirs = []
for f in dirs_1:
  temp = glob.glob(os.path.join(os.path.abspath(sys.argv[1]), f, '*/*.jpg'))
  imgdirs += [i for i in temp]
print(len(imgdirs))

def det_img(imgdir, fa):
    input_ = io.imread(imgdir)
    preds = fa.get_landmarks(input_)
    return preds


fa = face_alignment.FaceAlignment(
    face_alignment.LandmarksType._2D, flip_input=False)

for imgdir in tqdm.tqdm(imgdirs):
    preds = det_img(imgdir, fa)
    pickle.dump(preds, open(imgdir.replace('.jpg', '_ldmk.pickle'), 'wb'))
